rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Letters collection
    match /letters/{letterId} {
      // Allow anyone to read letters (needed for sharing)
      allow read: if true;
      
      // Allow creation if validation passes
      allow create: if 
        // Required fields
        request.resource.data.keys().hasAll(['title', 'body', 'createdAt']) &&
        
        // Validate title
        request.resource.data.title is string &&
        request.resource.data.title.size() > 0 &&
        request.resource.data.title.size() <= 200 &&
        
        // Validate body
        request.resource.data.body is string &&
        request.resource.data.body.size() > 0 &&
        request.resource.data.body.size() <= 10000 &&
        
        // Validate recipientName (optional)
        (
          !('recipientName' in request.resource.data) || 
          request.resource.data.recipientName == null ||
          (request.resource.data.recipientName is string && request.resource.data.recipientName.size() <= 100)
        );

      // Letters are immutable - no updates or deletes
      allow update, delete: if false;
    }
  }
}
